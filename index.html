<!DOCTYPE html>
<html lang="ar" dir="rtl" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جدول رفعات القوة (RPE)</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap');
        body {
            font-family: 'Tajawal', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 100%;
            padding: 1rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        .card:hover {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        .input-group {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }
        .input-group label {
            width: 100px;
            font-weight: 600;
            color: #4b5563;
        }
        .input-group input {
            flex-grow: 1;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            text-align: right;
            margin-left: 0.5rem;
            background-color: white;
            transition: all 0.3s;
            font-weight: 500;
        }
        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .btn {
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-save {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        
        /* Week Navigator Styles */
        .week-btn {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.125rem;
            border: 2px solid #3b82f6;
            color: #3b82f6;
            background-color: transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .week-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.2);
        }
        .week-btn-active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border-color: transparent;
        }

        /* Day Navigator Styles */
        .day-btn {
            flex-grow: 1;
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 0.875rem;
            border: 2px solid #e5e7eb;
            color: #6b7280;
            background-color: transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
        }
        .day-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        .day-btn-active {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            border-color: transparent;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        /* Exercise Styles */
        .exercise-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-radius: 0.875rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .exercise-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }
        .main-exercise {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-left: 4px solid #3b82f6;
        }
        .accessory-exercise {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-left: 4px solid #10b981;
        }

        /* Progress Bar */
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background-color: #e5e7eb;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Dark Mode Styles */
        .light body {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #1f2937;
        }
        .light .card {
            background-color: #ffffff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }
        .light .bg-gray-50 {
            background-color: #f9fafb;
        }
        .light .bg-white {
            background-color: #ffffff;
        }
        .light input {
            background-color: white;
            color: #1f2937;
        }
        .light .modal-content {
            background-color: white;
            color: #1f2937;
        }
        .dark body {
            background: linear-gradient(135deg, #1a202c, #2d3748);
            color: #e2e8f0;
        }
        .dark .card {
            background-color: #2d3748;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .dark .bg-gray-50 {
            background-color: #242a35;
        }
        .dark .bg-white {
            background-color: #2d3748;
        }
        .dark input {
            background-color: #1f2937;
            color: #e2e8f0;
            border-color: #4a5568;
        }
        .dark .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark .week-btn {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: transparent;
        }
        .dark .week-btn-active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }
        .dark .day-btn {
            border-color: #4a5568;
            color: #a0aec0;
        }
        .dark .day-btn-active {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
        }
        .dark .exercise-card {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            border-color: #4a5568;
        }
        .dark .main-exercise {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            border-left: 4px solid #3b82f6;
        }
        .dark .accessory-exercise {
            background: linear-gradient(135deg, #065f46, #047857);
            border-left: 4px solid #10b981;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 1.5rem;
            padding: 1.5rem;
            color: white;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        /* Stats Section */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: white;
            border-radius: 0.875rem;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.03);
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #3b82f6;
        }
        .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        /* NEW: Improved text visibility for sets, reps and RPE */
        .exercise-info {
            font-weight: 700;
            font-size: 0.9rem;
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            display: inline-block;
        }
        .sets-reps-info {
            background-color: #f3f4f6;
            color: #1f2937;
            border: 1px solid #d1d5db;
        }
        .dark .sets-reps-info {
            background-color: #374151;
            color: #f9fafb;
            border: 1px solid #4b5563;
        }
        .rpe-info {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            font-weight: 800;
        }
        .dark .rpe-info {
            background: linear-gradient(135deg, #92400e, #b45309);
            color: #fef3c7;
        }
        .target-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .exercise-name {
            font-weight: 700;
            color: #1f2937;
        }
        .dark .exercise-name {
            color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center p-4">
    <!-- Theme Toggle Button -->
    <button id="theme-toggle" class="absolute top-4 right-4 p-3 rounded-full bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 shadow-lg z-10">
        <i class="fas fa-moon"></i>
    </button>
    <!-- RPE Explanation Button -->
    <button id="open-rpe-modal" class="absolute top-4 left-4 p-3 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold shadow-lg z-10">
        <i class="fas fa-question"></i>
    </button>

    <div class="container max-w-lg mx-auto">
        <div class="header">
            <h1 class="text-3xl font-bold mb-2">برنامج تدريب القوة</h1>
            <p class="opacity-90">تدريب RPE الذكي والمتطور</p>
        </div>

        <!-- WEEK NAVIGATOR -->
        <div id="week-navigator" class="flex justify-center space-x-3 my-6">
            <button id="btn-WEEK-1" class="week-btn" onclick="showWeek('WEEK 1')">
                <span>1</span>
            </button>
            <button id="btn-WEEK-2" class="week-btn" onclick="showWeek('WEEK 2')">
                <span>2</span>
            </button>
            <button id="btn-WEEK-3" class="week-btn" onclick="showWeek('WEEK 3')">
                <span>3</span>
            </button>
            <button id="btn-WEEK-4" class="week-btn" onclick="showWeek('WEEK 4')">
                <span>4</span>
            </button>
            <button id="btn-DELOAD" class="week-btn" onclick="showWeek('DELOAD')">
                <span>D</span>
            </button>
        </div>
        
        <div id="pr-section" class="card">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-trophy text-yellow-500 ml-2"></i>
                تتبع الأوزان القصوى (PRs)
            </h2>
            <div class="space-y-4">
                <div class="input-group">
                    <label for="pr-squat">
                        <i class="fas fa-weight-hanging text-blue-500 ml-1"></i>
                        سكوات:
                    </label>
                    <input type="number" id="pr-squat" placeholder="أدخل وزن PR" class="text-right">
                </div>
                <div class="input-group">
                    <label for="pr-bench">
                        <i class="fas fa-dumbbell text-blue-500 ml-1"></i>
                        بنش:
                    </label>
                    <input type="number" id="pr-bench" placeholder="أدخل وزن PR" class="text-right">
                </div>
                <div class="input-group">
                    <label for="pr-deadlift">
                        <i class="fas fa-weight text-blue-500 ml-1"></i>
                        ديدليفت:
                    </label>
                    <input type="number" id="pr-deadlift" placeholder="أدخل وزن PR" class="text-right">
                </div>
            </div>
            <button onclick="savePRs()" class="btn btn-save w-full mt-6">
                <i class="fas fa-save"></i>
                حفظ الأوزان الأساسية
            </button>
        </div>

        <!-- Stats Section -->
        <div id="stats-section" class="stats-grid fade-in" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="squat-stat">0</div>
                <div class="stat-label">سكوات (كجم)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="bench-stat">0</div>
                <div class="stat-label">بنش (كجم)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="deadlift-stat">0</div>
                <div class="stat-label">ديدليفت (كجم)</div>
            </div>
        </div>

        <div id="program-section">
            <!-- Week/Day content will be injected here -->
        </div>
    </div>

    <!-- RPE Modal -->
    <div id="rpe-modal" class="modal-overlay">
        <div class="modal-content card">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-info-circle text-blue-500 ml-2"></i>
                ما هو RPE وكيف تطبقه؟
            </h2>
            <div class="space-y-4 text-right">
                <p>
                    <strong>RPE</strong> (معدل الجهد المبذول) هو مقياس لمدى صعوبة الجولة، من 1 إلى 10.
                </p>
                <p>
                    بدلاً من الأوزان الثابتة، البرنامج يطلب منك "هدف" (مثل RPE 8). مهمتك هي اختيار الوزن الذي يوصلك لهذا الهدف بناءً على شعورك اليوم.
                </p>
                <h3 class="text-xl font-bold mt-2">المقياس المبسط:</h3>
                <ul class="list-disc list-inside space-y-2">
                    <li><strong>RPE 10:</strong> فشل عضلي. ما قدرت تسوي أي تكرار زيادة أبداً.</li>
                    <li><strong>RPE 9:</strong> صعب جداً. كان باقي فيك تكرار واحد فقط.</li>
                    <li><strong>RPE 8:</strong> صعب. كان باقي فيك تكرارين. (هذا هو الهدف الشائع)</li>
                    <li><strong>RPE 7:</strong> متوسط الصعوبة. كان باقي فيك 3 تكرارات.</li>
                    <li><strong>RPE 6:</strong> سهل. كان باقي فيك 4 تكرارات. (غالباً للإحماء أو الديلود)</li>
                    <li><strong>RPE 5:</strong> سهل جداً. إحماء.</li>
                </ul>
                <p class="mt-4">
                    <strong>كيف تطبقه:</strong> إذا كان هدفك (3 تكرارات @ RPE 8)، ابدأ بوزن تعتقد أنه سيجعلك تنهي 3 تكرارات وأنت تشعر أنه "باقي تكرارين فيك". ثم سجل الوزن الذي استخدمته والـRPE الفعلي الذي شعرت به.
                </p>
            </div>
            <button id="close-rpe-modal" class="btn btn-secondary w-full mt-6">
                <i class="fas fa-times"></i>
                إغلاق
            </button>
        </div>
    </div>

    <script>
        // --- Accessory exercises are 2 sets of '5-8' reps ---
        const baseProgramData = {
            'DAY 1': [
                { name: 'Comp Squat', sets: 1, reps: 1, target_rpe: 6 },
                { name: 'Comp Squat', sets: 2, reps: 3, target_rpe: 6 },
                { name: 'Close grip Bench press', sets: 1, reps: 1, target_rpe: 6 },
                { name: 'Close grip Bench press', sets: 2, reps: 3, target_rpe: 6 },
                { name: 'DB Split Squat', sets: 2, reps: '5-8', target_rpe: null },
                { name: 'DB Press', sets: 2, reps: '5-8', target_rpe: null },
                { name: 'Single Cable Tricep Extension', sets: 2, reps: '5-8', target_rpe: null }
            ],
            'DAY 2': [
                { name: 'Paused Deadlift', sets: 1, reps: 1, target_rpe: 6 },
                { name: 'Paused Deadlift', sets: 2, reps: 3, target_rpe: 6 },
                { name: 'Comp Bench press', sets: 1, reps: 1, target_rpe: 6 },
                { name: 'Comp Bench press', sets: 2, reps: 3, target_rpe: 6 },
                { name: 'Back Hyperextension', sets: 2, reps: '5-8', target_rpe: null },
                { name: 'Lat Pull Down', sets: 2, reps: '5-8', target_rpe: null },
                { name: 'Seated Cable Row', sets: 2, reps: '5-8', target_rpe: null }
            ],
            'DAY 3': [
                { name: 'Tempo Squat', sets: 1, reps: 2, target_rpe: 6 },
                { name: 'Tempo Squat', sets: 2, reps: 6, target_rpe: 6 },
                { name: 'Long pause Bench press', sets: 1, reps: 1, target_rpe: 6 },
                { name: 'Long pause Bench press', sets: 2, reps: 4, target_rpe: 6 },
                { name: 'Leg Press', sets: 2, reps: '5-8', target_rpe: null },
                { name: 'Machine Shoulder Press', sets: 2, reps: '5-8', target_rpe: null },
                { name: 'Pull-ups', sets: 2, reps: '5-8', target_rpe: null }
            ],
            'DAY 4': [
                { name: 'Comp Deadlift', sets: 1, reps: 1, target_rpe: 6 },
                { name: 'Comp Deadlift', sets: 1, reps: 3, target_rpe: 6 },
                { name: 'Comp Deadlift', sets: 1, reps: 6, target_rpe: 6 },
                { name: 'Tempo Bench press', sets: 1, reps: 2, target_rpe: 6 },
                { name: 'Tempo Bench press', sets: 2, reps: 6, target_rpe: 6 },
                { name: 'Weighted Dips', sets: 2, reps: '5-8', target_rpe: null },
                { name: 'RDL', sets: 2, reps: '5-8', target_rpe: null },
                { name: 'Incline DB Press', sets: 2, reps: '5-8', target_rpe: null }
            ]
        };

        // --- Helper function to create progressed weeks ---
        function createProgressedWeek(baseWeekData, weekNumber) {
            const newWeekData = JSON.parse(JSON.stringify(baseWeekData));
            let rpeTarget = 6;
            
            // تحديد RPE بناءً على رقم الأسبوع
            switch(weekNumber) {
                case 1:
                    rpeTarget = 6;
                    break;
                case 2:
                    rpeTarget = 7;
                    break;
                case 3:
                    rpeTarget = 8;
                    break;
                case 4:
                    rpeTarget = 9;
                    break;
                case 5: // Deload
                    rpeTarget = 5;
                    break;
            }
            
            // تطبيق RPE على التمارين الرئيسية فقط
            for (const day in newWeekData) {
                newWeekData[day].forEach(exercise => {
                    // التمارين الرئيسية هي التي تحتوي على target_rpe
                    if (exercise.target_rpe !== null) {
                        exercise.target_rpe = rpeTarget;
                    }
                });
            }
            return newWeekData;
        }

        // --- Full Program Data with CORRECTED RPE PROGRESSION ---
        const programData = {
            'WEEK 1': createProgressedWeek(baseProgramData, 1),
            'WEEK 2': createProgressedWeek(baseProgramData, 2),
            'WEEK 3': createProgressedWeek(baseProgramData, 3),
            'WEEK 4': createProgressedWeek(baseProgramData, 4),
            'DELOAD': createProgressedWeek(baseProgramData, 5) // Deload
        };

        // --- Renders week header, day nav, and calls showDay ---
        function showWeek(weekKey) {
            const programSection = document.getElementById('program-section');
            programSection.innerHTML = ''; // Clear previous week
            
            const weekData = programData[weekKey];
            if (!weekData) return;

            // Update active week button
            document.querySelectorAll('.week-btn').forEach(btn => {
                btn.classList.remove('week-btn-active');
            });
            document.getElementById(`btn-${weekKey.replace(/\s/g, '-')}`).classList.add('week-btn-active');

            // Add Week Header
            const weekHeader = document.createElement('div');
            weekHeader.className = 'card text-center mb-6';
            weekHeader.innerHTML = `
                <h2 class="text-2xl font-bold mb-2">${weekKey}</h2>
                <div class="progress-bar">
                    <div class="progress-fill" id="week-progress" style="width: ${weekKey === 'DELOAD' ? '100%' : (parseInt(weekKey.split(' ')[1]) / 4 * 100)}%"></div>
                </div>
            `;
            programSection.appendChild(weekHeader);

            // Add Day Navigator
            const dayNav = document.createElement('div');
            dayNav.id = 'day-navigator';
            dayNav.className = 'flex justify-center space-x-2 my-4';
            
            let dayIndex = 1;
            for (const dayKey in weekData) {
                const dayNum = dayIndex++;
                dayNav.innerHTML += `
                    <button id="btn-${weekKey}-${dayKey}" class="day-btn" onclick="showDay('${weekKey}', '${dayKey}')">
                        <i class="fas fa-dumbbell ml-1"></i>
                        اليوم ${dayNum}
                    </button>
                `;
            }
            programSection.appendChild(dayNav);

            // Add container for day content
            const dayContent = document.createElement('div');
            dayContent.id = 'day-content';
            programSection.appendChild(dayContent);

            // Show the first day by default
            const firstDayKey = Object.keys(weekData)[0];
            showDay(weekKey, firstDayKey);
        }

        // --- Renders a single day's content ---
        function showDay(weekKey, dayKey) {
            const dayContent = document.getElementById('day-content');
            dayContent.innerHTML = ''; // Clear previous day

            // Update active day button
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.remove('day-btn-active');
            });
            const activeDayButton = document.getElementById(`btn-${weekKey}-${dayKey}`);
            if (activeDayButton) {
                activeDayButton.classList.add('day-btn-active');
            }

            const dayData = programData[weekKey][dayKey];
            const savedProgress = JSON.parse(localStorage.getItem('programProgress')) || {};

            const dayCard = document.createElement('div');
            dayCard.className = 'card bg-gray-50 rounded-lg p-4 mb-4 fade-in';
            dayCard.innerHTML = `<h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-calendar-day text-blue-500 ml-2"></i>${dayKey}</h3>`;
                
            dayData.forEach((exercise, index) => {
                const exerciseDiv = document.createElement('div');
                const isMainExercise = exercise.target_rpe !== null;
                exerciseDiv.className = `exercise-card ${isMainExercise ? 'main-exercise' : 'accessory-exercise'}`;
                
                const fullDayKey = `${weekKey.replace(/\s/g, '-')}-${dayKey.replace(/\s/g, '-')}`;
                const exerciseId = `${fullDayKey}-${exercise.name.replace(/\s/g, '-')}-${index}`;
                const progData = savedProgress[exerciseId] || {};

                let targetDisplay = `${exercise.sets} مجموعات × ${exercise.reps} تكرارات`;
                if (exercise.target_rpe) {
                    targetDisplay += ` @ RPE ${exercise.target_rpe}`;
                }

                const exerciseIcon = isMainExercise ? 
                    '<i class="fas fa-fire text-blue-500 ml-2"></i>' : 
                    '<i class="fas fa-dumbbell text-green-500 ml-2"></i>';

                exerciseDiv.innerHTML = `
                    <div class="flex justify-between items-center w-full">
                        <span class="exercise-name flex items-center">${exerciseIcon} ${exercise.name}</span>
                        <div class="target-display">
                            <span class="exercise-info sets-reps-info">${exercise.sets} × ${exercise.reps}</span>
                            ${exercise.target_rpe ? `<span class="exercise-info rpe-info">RPE ${exercise.target_rpe}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-row justify-between w-full mt-4 space-x-2 space-x-reverse">
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <label class="text-sm font-medium">الوزن المستخدم:</label>
                            <input type="number" id="weight-${exerciseId}" value="${progData.weight || ''}" class="w-20 text-center border rounded-lg p-2">
                        </div>
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <label class="text-sm font-medium">الـRPE الفعلي:</label>
                            <input type="number" id="rpe-${exerciseId}" min="1" max="10" value="${progData.rpe || ''}" class="w-16 text-center border rounded-lg p-2">
                        </div>
                    </div>
                `;
                dayCard.appendChild(exerciseDiv);
            });

            // Refactored saveDay call
            const saveButton = document.createElement('button');
            saveButton.className = 'btn btn-save w-full mt-4';
            saveButton.innerHTML = '<i class="fas fa-save"></i> حفظ اليوم';
            saveButton.onclick = () => saveDay(weekKey, dayKey);
            dayCard.appendChild(saveButton);

            dayContent.appendChild(dayCard);
        }
        
        // --- REFACTORED: saveDay now takes weekKey and dayKey ---
        function saveDay(weekKey, dayKey) {
            const savedProgress = JSON.parse(localStorage.getItem('programProgress')) || {};
            const exercises = programData[weekKey][dayKey];
            const fullDayKey = `${weekKey.replace(/\s/g, '-')}-${dayKey.replace(/\s/g, '-')}`;

            exercises.forEach((exercise, index) => {
                const exerciseId = `${fullDayKey}-${exercise.name.replace(/\s/g, '-')}-${index}`;
                
                const weightInput = document.getElementById(`weight-${exerciseId}`);
                const rpeInput = document.getElementById(`rpe-${exerciseId}`);
                
                if (!savedProgress[exerciseId]) {
                    savedProgress[exerciseId] = {};
                }
                
                if (weightInput) savedProgress[exerciseId].weight = weightInput.value;
                if (rpeInput) savedProgress[exerciseId].rpe = rpeInput.value;
            });

            localStorage.setItem('programProgress', JSON.stringify(savedProgress));
            
            // Show success message
            const saveButton = document.querySelector('.btn-save');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '<i class="fas fa-check"></i> تم الحفظ!';
            saveButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            
            setTimeout(() => {
                saveButton.innerHTML = originalText;
                saveButton.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
            }, 2000);
        }

        function savePRs() {
            const squatPR = document.getElementById('pr-squat').value;
            const benchPR = document.getElementById('pr-bench').value;
            const deadliftPR = document.getElementById('pr-deadlift').value;

            if (squatPR || benchPR || deadliftPR) {
                const prs = {
                    squat: parseFloat(squatPR) || 0,
                    bench: parseFloat(benchPR) || 0,
                    deadlift: parseFloat(deadliftPR) || 0
                };
                localStorage.setItem('userPRs', JSON.stringify(prs));
                
                // Update stats
                updateStats();
                
                // Show success message
                const saveButton = document.querySelector('#pr-section .btn-save');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="fas fa-check"></i> تم الحفظ!';
                saveButton.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
                }, 2000);
            } else {
                alert('الرجاء إدخال وزن واحد على الأقل.');
            }
        }

        function loadPRs() {
            const prs = JSON.parse(localStorage.getItem('userPRs')) || {};
            document.getElementById('pr-squat').value = prs.squat || '';
            document.getElementById('pr-bench').value = prs.bench || '';
            document.getElementById('pr-deadlift').value = prs.deadlift || '';
            
            updateStats();
        }
        
        function updateStats() {
            const prs = JSON.parse(localStorage.getItem('userPRs')) || {};
            if (prs.squat || prs.bench || prs.deadlift) {
                document.getElementById('stats-section').style.display = 'grid';
                document.getElementById('squat-stat').textContent = prs.squat || '0';
                document.getElementById('bench-stat').textContent = prs.bench || '0';
                document.getElementById('deadlift-stat').textContent = prs.deadlift || '0';
            }
        }

        // --- Theme Toggle Functionality ---
        const themeToggleBtn = document.getElementById('theme-toggle');

        function setTheme(theme) {
            document.documentElement.className = theme;
            localStorage.setItem('theme', theme);
            updateToggleButton(theme);
        }

        function updateToggleButton(theme) {
            const isDarkMode = theme === 'dark';
            themeToggleBtn.innerHTML = isDarkMode ? 
                '<i class="fas fa-sun"></i>' : 
                '<i class="fas fa-moon"></i>';
        }

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        });

        // --- RPE Modal Functionality ---
        const rpeModal = document.getElementById('rpe-modal');
        const openRpeModalBtn = document.getElementById('open-rpe-modal');
        const closeRpeModalBtn = document.getElementById('close-rpe-modal');

        openRpeModalBtn.addEventListener('click', () => {
            rpeModal.classList.add('visible');
        });

        closeRpeModalBtn.addEventListener('click', () => {
            rpeModal.classList.remove('visible');
        });

        rpeModal.addEventListener('click', (e) => {
            if (e.target === rpeModal) {
                rpeModal.classList.remove('visible');
            }
        });

        // --- Initial Setup ---
        window.onload = function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            loadPRs();
            showWeek('WEEK 1'); // Load Week 1 by default

            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('Service Worker registered with scope:', registration.scope);
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                });
            }
        }
    </script>
</body>
</html>
